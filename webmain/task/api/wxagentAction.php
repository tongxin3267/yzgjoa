<?php
class wxagentClassAction extends apiAction { public function initAction() { $this->display= false; } public function indexAction() { $agenttype = $this->get('agenttype'); $wxdiao = m('weixin:diao'); $xml = $wxdiao->getxml(); $MsgType = $xml->getval('MsgType'); $user = $xml->getval('FromUserName'); $uid = $this->db->getmou('[Q]admin','id',"`user`='$user'"); if($MsgType =='location'){ m('location')->add($user, array( 'location_x' => $xml->getval('Location_X'), 'location_y' => $xml->getval('Location_Y'), 'scale' => $xml->getval('Scale'), 'label' => $xml->getval('Label'), 'msgid' => $xml->getval('MsgId'), 'agentid' => $xml->getval('AgentID'), 'type' => '0' )); } if($MsgType =='text'){ $cropid = $xml->getval('ToUserName'); $cont = $xml->getval('Content');; $str = '<xml>
				<ToUserName><![CDATA['.$user.']]></ToUserName>
				<FromUserName><![CDATA['.$cropid.']]></FromUserName>
				<CreateTime>'.time().'</CreateTime>
				<MsgType><![CDATA[text]]></MsgType>
				<Content><![CDATA['.$cont.']]></Content>
			</xml>'; $strb = $wxdiao->EncryptMsg($str); echo $strb; } if($MsgType =='event'){ $event = $xml->getval('Event'); if($event=='LOCATION'){ m('location')->add($user, array( 'location_x' => $xml->getval('Latitude'), 'location_y' => $xml->getval('Longitude'), 'scale' => 0, 'precision' => $xml->getval('Precision'), 'agentid' => $xml->getval('AgentID'), 'type' => '1' )); } if($event=='subscribe'){ m('weixin:user')->subscribe($user,1); } if($event=='unsubscribe'){ m('weixin:user')->subscribe($user,4); } if($event=='click'){ $cropid = $xml->getval('ToUserName'); $evtkey = $xml->getval('EventKey'); if('untodo' == $evtkey){ $cont = m('reim')->getuntodo($uid); if($cont==''){ $cont = '没有未读消息'; }else{ $cont.="\n点击菜单[会话列表]查看详情"; } $str = '<xml><ToUserName><![CDATA['.$user.']]></ToUserName><FromUserName><![CDATA['.$cropid.']]></FromUserName> <CreateTime>'.time().'</CreateTime><MsgType><![CDATA[text]]></MsgType><Content><![CDATA['.$cont.']]></Content></xml>'; $strb = $wxdiao->EncryptMsg($str); echo $strb; } } } } }