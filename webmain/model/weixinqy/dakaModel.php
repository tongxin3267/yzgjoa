<?php
class weixinqy_dakaClassModel extends weixinqyModel { public function getrecord($uid='', $dt='') { $url = $this->gettourl('URL_checkindata'); $agentid = m('weixinqy:index')->getagentid('打卡'); $barr = $this->backarr; if($agentid==-1){ $msg= '请先添加打卡应用'; $barr['msg'] = $msg; return $barr; } if($dt=='')$dt = $this->rock->date; $startdt = $dt; $endddt = $dt.' 23:59:59'; $starttime = strtotime($startdt); $endtime = strtotime($endddt); $where = '1=1'; if($uid!='')$where = '`id` in('.$uid.')'; $urows = $this->db->getrows('[Q]admin', $where,'`id`,`user`'); $useridlist = ''; $uarrs = array(); foreach($urows as $k=>$rs){ $useridlist.=',"'.$rs['user'].'"'; $uarrs[$rs['user']] = $rs['id']; } if($useridlist==''){ $msg= '没有相关人员'; $barr['msg'] = $msg; return $barr; } $useridlist = substr($useridlist, 1); $token = $this->gettoken($agentid); $url .= '?access_token='.$token.''; $body = '{"opencheckindatatype": 3,"starttime": '.$starttime.',"endtime": '.$endtime.',"useridlist": ['.$useridlist.']}'; $result = c('curl')->postcurl($url, $body); $okload = 0; $dbs = m('kqdkjl'); $dbs1 = m('location'); if($result!=''){ $arr = json_decode($result, true); $barr['errcode'] = $arr['errcode']; $barr['msg'] = $arr['errmsg']; if($barr['errcode']==0 && isset($arr['checkindata'])){ $rows = $arr['checkindata']; $barr['checkindata'] = $rows; foreach($rows as $k=>$rs){ $userid = $rs['userid']; $checkin_type = $rs['checkin_type']; $uid = (int)$this->rock->arrvalue($uarrs, $userid, '0'); if($uid==0)continue; $dkdt = date('Y-m-d H:i:s', $rs['checkin_time']); if($checkin_type=='外出打卡'){ $where = "`uid`='$uid' and `optdt`='$dkdt' and `type`=2"; if($dbs1->rows($where)==0){ $okload++; $dbs1->insert(array( 'uid' => $uid, 'optdt' => $dkdt, 'type' => 2, 'label' => $rs['location_detail'], 'explain' => $rs['notes'], )); } }else{ $where = "`uid`='$uid' and `dkdt`='$dkdt' and `type`=7"; if($dbs->rows($where)==0){ $okload++; $dbs->insert(array( 'uid' => $uid, 'dkdt' => $dkdt, 'type' => 7, 'optdt' => $this->rock->now, 'address' => $rs['location_detail'], 'explain' => $rs['notes'], )); } } } $barr['okload'] = $okload; } } return $barr; } }