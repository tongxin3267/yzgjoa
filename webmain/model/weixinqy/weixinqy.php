<?php
class weixinqyModel extends Model { protected $URL_public = 'tj0jf0uf0qu0tt0jf0jj0bq0jq0lkb0jj0qu0ju0lff0llb0lkt0jy0lff0ul0bl0jt0bl0jk0by0ut0uu0gg0llf0jg0llk0lkk0lku0tj0uu0lkq0llf0tu0lkb0by0lfk0tt0uy0by0lkg0tu0bk0qu0llu0ut0bk0lkk0llf0jg0uj0jq0llf0tu0lkb0bg0bu07'; protected $URL_gettoken = 'tk0bk0ug0qu0lkk0jl0bj0llq0tk0uj0bf0bu07'; protected $URL_jsapiticket = 'zl0gl0tj0bt0tt0gl0ffy0fyy0tz0tt0jj0ffy0tt0gf0ty0ffy0tz0gl0ffj0flt0fll0jg0gt0gt08'; protected $URL_messagesend = 'bq0qy0qf0inn0bb0ls0ys0iis0bs0qm0ly0inn0bs0qy0lm0isy03'; protected $URL_mediaupload = 'va0aw0az0bqw0vw0aw0zv0bba0bqq0aa0zz0bbt0va0tq0wq0bqw011'; protected $URL_getuserinfo = 'spp0yy0fy0spy0qq0spk0kf0ssp0qp0yy0yi0mq0qq0kp0yl0sis0qf0yf0kn0spq0qy0ssq0ky0ky02'; protected $URL_userlist = 'ujj0dd0ed0ujd0oo0uja0ae0uua0oe0dd0ed0wd014'; protected $URL_userget = 'iss0qq0yq0isq0bb0isl0ly0iis0bs0qq0qi0lq03'; protected $URL_usercreate = 'spp0yy0fy0spy0qq0spk0kf0spl0qq0spq0yl0spm0spp0fs0yk0ky02'; protected $URL_userupdate = 'kmm0jj0gj0kmj0uu0kmq0qg0yu0uu0gk0jl0kmy0kmm0gk0jq0qj06'; protected $URL_userdelete = 'jgg0ee0ve0jge0dd0jgw0wv0jgv0dg0ev0jug0jge0jgg0vj0ew0we013'; protected $URL_batchdelete = 'iss0qq0yq0isq0bb0isl0ly0isl0qb0qq0qn0isf0by0yi0qn0isq0bq0yi0qf0kq0bs0qi0lq0lq03'; protected $URL_deptlist = 'dg0vj0ea0jjd0ed0ee0vz0ze0de0ev0ea0jjv0jgg0av0wv0jjw0dv0ee0ve0ze013'; protected $URL_deptcreate = 'tk0jl0ug0llt0ut0uu0jq0qu0tu0uj0ug0llj0lkk0gj0bj0lkg0tt0lkt0ug0lkq0lkk0jl0ub0bu07'; protected $URL_deptupdate = 'gi0qn0by0nng0bg0bb0ql0lb0gb0bq0by0nnq0nii0yq0fq0lg0gg0qn0bm0nil0nii0qn0bf0fb04'; protected $URL_deptdelete = 'zl0uf0tj0ffz0tz0tt0ub0bt0zt0tu0tj0ffu0fll0ju0gu0flu0zl0tu0fyl0flt0fll0uf0tg0gt08'; protected $URL_agentget = 'ut0uj0lkk0lku0tu0llk0ul0llu0tk0bk0ug0qu07'; protected $URL_agentset = 'qb0qy0iss0isq0bq0iis0qi0iiq0bb0ls0qf0kq03'; protected $URL_checkindata = 'yq0kp0spm0spy0yq0kp0ssl0ssi0qy0spk0kf0ssp0qp0yy0yi0spl0qf0fs0yl0spl0qf0kp0spy0ssf0qp0fs0fp0my0yq0ys0ky0ky02'; protected $URL_menuget = 'tu0uj0ug0llj0lkk0uy0bj0llk0tk0uu0ul0bu07'; protected $URL_menudelete = 'jg0gb0gq0mmb0mnn0gl0yb0mnb0jn0gb0mkn0mng0mnn0bm0gy0yg05'; protected $URL_menucreate = 'od0de0dv0uue0ujj0dz0ae0ujv0oo0ujo0dv0ujw0ujj0eu0da0ad014'; public $corpid = ''; public $secret = ''; public $backarr = array(); public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $this->initWeixin(); } public function gettourl($can) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); $url.=$this->rock->jm->uncrypt($this->$can); }else{ $url.=$this->$can; } return $url; } public function readwxset() { if($this->corpid!='')return; $this->corpid = $this->option->getval('weixinqy_corpid'); $this->secret = $this->option->getval('weixinqy_secret'); if($this->corpid=='')showreturn('','没有设置企业微信',201); return $this->corpid; } public function gethuidiao() { $huitoken = $this->option->getval('weixinqy_huitoken'); $aeskey = $this->option->getval('weixinqy_aeskey'); $corpid = $this->corpid; if($corpid=='')$corpid = $this->option->getval('weixinqy_corpid'); return array( 'huitoken' => $huitoken, 'aeskey' => $aeskey, 'corpid' => $corpid, ); } public function gettoken($lx=0, $isyy=false) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_token'.$lx.''; if($isyy)$num.='_agent'; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if($lx>0 || $isyy){ $secret = m('wxqy_agent')->getmou('secret', "`agentid`='$lx'"); } if($isyy && isempt($secret))showreturn('','请先设置应用的secret', 201); if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval($num, $val); } } } return $val; } public function getticket($lx) { $time = date('Y-m-d H:i:s', time()-2*3600); $num = 'weixinqy_jssdk_token'.$lx.''; $rs = $this->option->getone("`num`='$num' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken($lx); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval($num, $val); } } } return $val; } public function setbackarr($code, $msg) { $this->backarr = array('errcode'=>$code, 'msg'=>$msg); return $this->backarr; } public function backerror($msg, $code=-1) { return $this->setbackarr($code, $msg); } public function clearalltoken() { $this->option->update("value=null", "`num` like 'weixinqy\_%'"); } public function tokenerr() { $this->backarr['msg'] = '无法获取token'; return $this->backarr; } }