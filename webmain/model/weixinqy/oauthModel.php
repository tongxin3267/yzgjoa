<?php
class weixinqy_oauthClassModel extends weixinqyModel { public function login() { $this->readwxset(); if($this->corpid==''){ $url = '?m=login&d=we#notuserid'; $this->rock->location($url); return false; } $burl = $this->rock->get('backurl'); $redurl = ''.URL.'?m=login&d=we&a=wxlogincode'; if($burl!='')$redurl.='&backurl='.$burl.''; $redirect_uri = urlencode($redurl); $url = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid='.$this->corpid.'&redirect_uri='.$redirect_uri.'&response_type=code&scope=snsapi_base&state=login#wechat_redirect'; $this->rock->location($url); return true; } public function logincode() { $code = $this->rock->get('code'); $state = $this->rock->get('state'); if($code=='')return; $agentid= $this->rock->session('wxqyagentid', '1000001'); $token = $this->gettoken($agentid); $url = ''.$this->gettourl('URL_getuserinfo').'?access_token='.$token.'&code='.$code.''; $result = c('curl')->getcurl($url); $UserId = $DeviceId = ''; if($result != ''){ $arr = json_decode($result); if(isset($arr->UserId))$UserId = $arr->UserId ; if(isset($arr->DeviceId))$DeviceId = $arr->DeviceId; } $userid = $UserId; $burl = $this->rock->get('backurl'); if(!isempt($userid)){ $usr = m('admin')->getone("`user`='$userid' and `status`=1",'id,pass'); if(!$usr)$userid=''; $ptoken = md5($usr['pass']); $url = '?m=login&d=we&user='.$this->rock->jm->base64encode($userid).'&ptoken='.$ptoken.''; if($burl!='')$url.='&backurl='.$burl.''; } if(isempt($userid)){ $url = '?m=login&d=we'; if($burl!='')$url.='&backurl='.$burl.''; $url.= '#notuserid'; } $this->rock->location($url); } }