<?php
 class weixin_agentClassModel extends weixinModel { public function initWeixin() { $this->settable('wx_agent'); } public function getagentlist() { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_agentlist').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode=='0'){ $agentlist = $arr->agentlist; $sid = '0'; foreach($agentlist as $k=>$rs){ $name = $rs->name; $agentid = $rs->agentid; $sid .= ','.$agentid.''; $ids = (int)$this->getmou('id', "`agentid`='$agentid'"); $where = ''; if($ids>0)$where="`id`=$ids"; $this->record(array( 'name' => $name, 'agentid' => $agentid, 'square_logo_url' => $rs->square_logo_url ), $where); } $this->delete("`agentid` not in($sid)"); } } return $this->backarr; } public function getagent($id) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_agentget').'?access_token='.$token.'&agentid='.$id.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode=='0'){ $this->update(array( 'name' => $arr->name, 'square_logo_url' => $arr->square_logo_url, 'description' => $arr->description, 'allow_userinfos' => json_encode($arr->allow_userinfos), 'allow_partys' => json_encode($arr->allow_partys), 'allow_tags' => json_encode($arr->allow_tags), 'close' => $arr->close, 'redirect_domain' => $arr->redirect_domain, 'report_location_flag' => $arr->report_location_flag, 'isreportuser' => $arr->isreportuser, 'isreportenter' => $arr->isreportenter, 'type' => $arr->type ), "`agentid`='$id'"); } } return $this->backarr; } public function setagent($id) { $rs = $this->getone("`agentid`='$id'"); if(!$rs)return $this->backarr; if($rs['type']==0){ $this->backarr['msg']='请先获取信息在更新'; return $this->backarr; } $body = '{"agentid": "'.$id.'","name":"'.$rs['name'].'","report_location_flag":"'.$rs['report_location_flag'].'","description":"'.$rs['description'].'","redirect_domain":"'.$rs['redirect_domain'].'","isreportuser":"'.$rs['isreportuser'].'","isreportenter":"'.$rs['isreportenter'].'"}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_agentset').'?access_token='.$token.''; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); } return $this->backarr; } }