<?php
class weixinModel extends Model { protected $URL_public = 'gq0qm0bm0lb0gg0qm0qq0fl0ql0nif0qq0lb0qb0nmm0nnf0nig0qk0nmm0bn0fn0qg0fn0qi0fk0bg0bb0yy0nnm0qy0nni0nii0nib0gq0bb0nil0nnm0gb0nif0fk0nmi0gg0bk0fk0niy0gb0fi0lb0nnb0bg0fi0nii0nnm0qy0bq0ql0nnm0gb0nif0fy0fb04'; protected $URL_gettoken = 'eb0zb0vw0tv0gbb0ag0za0ggt0eb0va0zj0zv012'; protected $URL_jsapiticket = 'zl0gl0tj0bt0tt0gl0ffy0fyy0tz0tt0jj0ffy0tt0gf0ty0ffy0tz0gl0ffj0flt0fll0jg0gt0gt08'; protected $URL_messagesend = 'de0ev0ea0juu0dd0wg0vg0jjg0dg0et0wv0juu0dg0ev0wt0jgv013'; protected $URL_mediaupload = 'tu0uj0ug0lkj0tj0uj0gt0llu0lkk0uu0gg0llb0tu0bk0jk0lkj07'; protected $URL_getuserinfo = 'nii0bb0qb0nib0gg0nif0fq0nni0gi0bb0bm0lg0gg0fi0by0nmn0gq0bq0fk0nig0gb0nng0fb0fb04'; protected $URL_kfsend = 'gq0fi0bg0nnb0gg0fi0by0nnq0gi0yf0fb0fb04'; protected $URL_userlist = 'bqq0aa0wa0bqa0vv0bqt0tw0bbt0vw0aa0wa0ua011'; protected $URL_userget = 'mnn0gg0bg0mng0jj0mny0yb0mmn0jn0gg0gm0yg05'; protected $URL_usercreate = 'lkk0uu0ju0lku0tt0lkb0bj0lkg0tt0lkt0ug0lkq0lkk0jl0ub0bu07'; protected $URL_userupdate = 'iss0qq0yq0isq0bb0isl0ly0kb0bb0yi0qn0isk0iss0yi0ql0lq03'; protected $URL_userdelete = 'iss0qq0yq0isq0bb0isl0ly0isy0bs0qy0ins0isq0iss0yi0ql0lq03'; protected $URL_batchdelete = 'nii0bb0qb0nib0gg0nif0fq0nif0bg0bb0bm0niy0gq0qn0bm0nib0gb0qn0by0lb0gi0bn0fb0fb04'; protected $URL_deptlist = 'qp0fs0yl0ssq0yq0yy0fm0my0qy0yf0yl0ssf0spp0lf0kf0ssk0qf0yy0fy0my02'; protected $URL_deptcreate = 'um0gk0jb0kku0ju0jj0gy0yj0uj0jg0jb0kkg0kmm0bg0qg0kmb0uu0kmu0jb0kmy0kmm0gk0jq0qj06'; protected $URL_deptupdate = 'zl0uf0tj0ffz0tz0tt0ub0bt0zt0tu0tj0ffu0fll0ju0gu0bz0zz0uf0ty0flb0fll0uf0tg0gt08'; protected $URL_deptdelete = 'oj0eu0dv0uuo0do0dd0ew0wd0od0de0dv0uue0ujj0ve0ae0uje0oj0de0utj0ujd0ujj0eu0da0ad014'; protected $URL_chatget = 'fy0mc0pcn0pcn0pcc0kl0ml0ppc0yc0ff0fp0mf01'; protected $URL_chatsend = 'ju0qm0kmy0kmy0kmm0bg0qg0kll0um0jg0qf0kmg06'; protected $URL_chatcreate = 'ut0bk0lkq0lkq0lkk0gj0bj0lkg0tt0lkt0ug0lkq0lkk0jl0ub0bu07'; protected $URL_chatupdate = 'do0aj0ujw0ujw0ujj0ve0ae0wo0oo0eu0dt0ujw0ujj0eu0da0ad014'; protected $URL_chatquit = 'av0tq0bqu0bqu0bqq0zw0tw0bgq0bqq0aw0bqa0ua011'; protected $URL_agentlist = 'ju0jg0kmm0kmj0uj0kkm0jk0kkj0uj0gk0kmj0kll0kmm0bq0qj0qj06'; protected $URL_agentget = 'bg0bq0nii0nib0gb0nni0bn0nnb0gi0fi0by0lb04'; protected $URL_agentset = 'do0de0ujj0ujd0od0uuj0du0uud0oo0aj0dv0wd014'; public $corpid = ''; public $backarr = array(); private $secret = ''; public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $this->initWeixin(); } public function gettourl($can) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); $url.=$this->rock->jm->uncrypt($this->$can); }else{ $url.=$this->$can; } return $url; } public function readwxset() { if($this->corpid!='')return; $this->corpid = $this->option->getval('weixin_corpid'); $this->secret = $this->option->getval('weixin_secret'); $this->chatsecret = $this->option->getval('weixin_chatsecret'); $this->kefusecret = $this->option->getval('weixin_kefusecret'); $this->chattb = (int)$this->option->getval('weixin_chattb','0'); if($this->corpid=='' || $this->secret=='')showreturn('','没有设置',201); return $this->corpid; } public function gethuidiao() { $huitoken = $this->option->getval('weixin_huitoken'); $aeskey = $this->option->getval('weixin_aeskey'); $corpid = $this->corpid; if($corpid=='')$corpid = $this->option->getval('weixin_corpid'); return array( 'huitoken' => $huitoken, 'aeskey' => $aeskey, 'corpid' => $corpid, ); } public function gettoken($lx=0) { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='weixin_token".$lx."' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if($lx==3)$secret = $this->chatsecret; if($lx==4)$secret = $this->kefusecret; if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval('weixin_token'.$lx.'', $val); } } } return $val; } public function getticket() { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='weixin_token1' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken(); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval('weixin_token1', $val); } } } return $val; } public function getchattoken() { return $this->gettoken(3); } public function getkefutoken() { return $this->gettoken(4); } public function setbackarr($code, $msg) { $this->backarr = array('errcode'=>$code, 'msg'=>$msg); } public function clearalltoken() { $this->option->setval('weixin_token0', ''); $this->option->setval('weixin_token1', ''); $this->option->setval('weixin_token3', ''); $this->option->setval('weixin_token4', ''); } public function getmessinfor($id, $lx=0) { $rs = m('im_mess')->getone($id); if(!$rs)return false; $type = $rs['type']; if($lx==1 && $type!='user')return false; $gid = $rs['receid']; $sendid = $rs['sendid']; $fid = (int)$rs['fileid']; $cont = $this->rock->jm->base64decode($rs['cont']); $msgtype= 'text'; if($fid>0){ $frs= m('file')->getone($fid); if($frs){ $fileext = $frs['fileext']; $filepath = $frs['filepath']; $filesize = $frs['filesize']; $fileimg = ',jpg,png,gif,arm,'; if(file_exists($filepath)){ if(contain($fileimg,','.$fileext.',')){ if($filesize<2*1024*1024){ $msgtype = 'image'; if($fileext == 'arm')$msgtype = 'voice'; } }elseif($fileext == 'mp4'){ if($filesize<10*1024*1024){ $msgtype = 'video'; } }else{ if($filesize<20*1024*1024){ $msgtype = 'file'; } } if($msgtype != 'text'){ $bars = m('weixin:media')->upload($filepath, $msgtype); if($bars['errcode']==0){ $cont = $bars['media_id']; $msgtype= $bars['type']; }else{ $msgtype= 'text'; } } } } } $arr = array( 'sendid' => $sendid, 'type' => $type, 'receid' => $gid, 'cont' => $cont, 'msgtype' => $msgtype, ); return $arr; } }