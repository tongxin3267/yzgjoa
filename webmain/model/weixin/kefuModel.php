<?php
 class weixin_kefuClassModel extends weixinModel { public function send($sendid, $receid, $cont, $msgtype='text') { $barr = $this->backarr; if($sendid == $receid){ $barr['msg'] = '发送人和接收人不能一样'; return $barr; } $dbs = m('admin'); $sendid = $dbs->getidtouser($sendid); if(isempt($sendid)){ $barr['msg'] = '发送人不存在'; return $barr; } $receid = $dbs->getidtouser($receid); if(isempt($receid)){ $barr['msg'] = '接收人不存在'; return $barr; } $token = $this->getkefutoken(); if(isempt($token)){ $barr['msg'] = '没配置客服secret'; return $barr; } $url = ''.$this->gettourl('URL_kfsend').'?access_token='.$token.''; $cont = str_replace('<br>',"\n", $cont); $stypes = 'content'; if($msgtype!='text')$stypes = 'media_id'; $body = '{"receiver":{"type": "kf","id": "'.$receid.'"},"sender":{"type": "userid","id": "'.$sendid.'"},"msgtype": "'.$msgtype.'","'.$msgtype.'":{ "'.$stypes.'": "'.$cont.'"}}'; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; } return $barr; } public function chattongbu($id) { $arr = $this->getmessinfor($id, 1); $barr = $this->backarr; if(!$arr){ $barr['msg'] = '消息'.$id.'不存在'; return $barr; } $barr = $this->send($arr['sendid'], $arr['receid'], $arr['cont'], $arr['msgtype']); $barr['id'] = $id; return $arr; } }