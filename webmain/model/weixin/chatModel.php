<?php
 class weixin_chatClassModel extends weixinModel { public function initWeixin() { $this->settable('wx_chat'); } public function getuids($list) { if(isempt($list))return ''; $userlar = explode('|', $list); $uids = ''; foreach($userlar as $user){ $ids = (int)$this->db->getmou('[Q]admin','id', "`user`='$user'"); if($ids>0)$uids.=','.$ids.''; } if($uids!='')$uids = substr($uids, 1); return $uids; } public function addchat($sendid, $sendname, $arr) { $name = $arr['Name']; $chatid = $arr['ChatId']; $owner = $arr['Owner']; $userlist = $arr['UserList']; $uids = $this->getuids($userlist); if($uids=='')return; $where = "`chatid`='$chatid'"; $id = (int)$this->getmou('id', $where); $remdb = m('reim'); if($id==0){ $id = $remdb->createchat($name, $sendid, $uids, $sendname,'', false); $where = ''; }else{ $oiud = (int)m('im_group')->getmou('id',"`id`='$id' and `type`<>2"); if($oiud == 0){ $id = $remdb->createchat($name, $sendid, $uids, $sendname,'', false); }else{ m('im_group')->update("`name`='$name'", $id); $remdb->adduserchat($id, $uids); m('im_groupuser')->delete("`gid`=$id and `uid` not in($uids)"); } } $uarr['id'] = $id; $uarr['chatid'] = $chatid; $uarr['name'] = $name; $uarr['owner'] = $owner; $uarr['userlist'] = $userlist; $this->record($uarr, $where); return $id; } public function getchatid($chatid, $sendid='', $sendname='') { $where = "`chatid`='$chatid'"; $id = (int)$this->getmou('id', $where); if($id==0 && $sendid!=''){ $id = m('reim')->createchat('会话', $sendid, '', $sendname); $this->insert(array( 'chatid' => $chatid, 'id' => $id, )); } return $id; } public function updatechat($arr) { $chatid = $arr['ChatId']; $this->getchatinfo($chatid); } public function quitchat($arr) { $chatid = $arr['ChatId']; $this->getchatinfo($chatid); } public function getchatinfo($chatid) { $token = $this->getchattoken(); if(isempt($token))return $this->backarr; $url = ''.$this->gettourl('URL_chatget').'?access_token='.$token.'&chatid='.$chatid.''; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $this->setbackarr($arr->errcode, $arr->errmsg); if($arr->errcode==0){ $info = $arr->chat_info; $userlist = join('|', $info->userlist); $urs = m('admin')->getone("`user`='".$info->owner."'",'id,name'); if($urs){ $ssarr['Name'] = $info->name; $ssarr['ChatId'] = $info->chatid; $ssarr['Owner'] = $info->owner; $ssarr['UserList'] = $userlist; $this->addchat($urs['id'], $urs['name'], $ssarr); } }else if($arr->errcode==86003){ $this->backarr['errcode'] = 0; $this->backarr['msg'] = '会话不存在已删除'; $sid = (int)$this->getmou('id', "`chatid`='$chatid'"); if($sid>0)m('reim')->deletechat($sid); $this->delete("`chatid`='$chatid'"); } } return $this->backarr; } public function send($sendid, $type, $gid, $cont, $msgtype='text') { $barr = $this->backarr; if(is_numeric($sendid)){ $sendid = m('admin')->getmou('user', $sendid); if(isempt($sendid)){ $barr['msg'] = 'user not found'; return $barr; } } $chatrs['userlist'] = ''; $udbss = m('wx_user'); if($type=='user'){ $type = 'single'; $gid = m('admin')->getmou('user', $gid); if($gid==$sendid){ $barr['msg'] = '单聊不能给自己发'; return $barr; } if($udbss->rows("`userid`='$gid' and `status`=1")==0){ $barr['msg'] = '['.$gid.']用户未关注企业号不能发送'; return $barr; } }else{ $chatrs = $this->getone("`id`='$gid'"); $gid = !$chatrs ? '' : $chatrs['chatid']; } if(isempt($gid)){ $barr['msg'] = ''.$type.' not found'; return $barr; } if($type == 'group'){ if(!contain('|'.$chatrs['userlist'].'|', '|'.$sendid.'|')){ $barr['msg'] = '发送人['.$sendid.']没在'.$gid.'微信会话里'; return $barr; } } $token = $this->getchattoken(); if(isempt($token)){ $barr['msg'] = '没配置会话secret'; return $barr; } $cont = str_replace('<br>',"\n", $cont); $stypes = 'content'; if($msgtype!='text')$stypes = 'media_id'; $url = ''.$this->gettourl('URL_chatsend').'?access_token='.$token.''; $body = '{"receiver":{"type": "'.$type.'","id": "'.$gid.'"},"sender": "'.$sendid.'","msgtype": "'.$msgtype.'","'.$msgtype.'":{ "'.$stypes.'": "'.$cont.'"}}'; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($type == 'group' && $arr->errcode==86217){ $cbarr = $this->upgchatuser($chatrs['id'], $sendid); $barr['adderrcode'] = $cbarr['errcode']; $barr['addmsg'] = $cbarr['msg']; } } return $barr; } private function _getchats($id) { $rs = m('im_group')->getone($id); $name = $rs['name']; if($rs['createid']==0)$rs['createid']=$this->adminid; $owner = m('admin')->getmou('user', $rs['createid']); $userlist = ''; $users = ''; $sql = "select b.user from `[Q]im_groupuser` a left join `[Q]admin` b on a.uid=b.id where a.gid='$id'"; $sar = $this->db->getall($sql); $len = 0; foreach($sar as $k=>$rs){ $userlist .= ',"'.$rs['user'].'"'; $users .= '|'.$rs['user'].''; $len++; } if($userlist!=''){ $userlist = substr($userlist,1); $users = substr($users,1); } return array( 'name' => $name, 'owner' => $owner, 'userlist' => $userlist, 'users' => $users, 'len' => $len, 'urows' => $sar, 'op_user'=> $this->rock->adminuser ); } public function chatcreate($id) { $barr = $this->backarr; $a = $this->_getchats($id); if($a['len']<3){ $barr['msg'] = '会话成员至少要3人'; return $barr; } $token = $this->getchattoken(); if(isempt($token))return $barr; $chatid = 'chatwx'.$id.''; $url = ''.$this->gettourl('URL_chatcreate').'?access_token='.$token.''; $body = '{"chatid": "'.$chatid.'","name": "'.$a['name'].'","owner": "'.$a['owner'].'","userlist": ['.$a['userlist'].']}'; $result = c('curl')->postcurl($url, $body); if($result != ''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $narr['id'] = $id; $narr['name'] = $a['name']; $narr['owner'] = $a['owner']; $narr['userlist'] = $a['users']; $narr['chatid'] = $chatid; $this->insert($narr); } } return $barr; } public function chatupdate($id) { $onrs = $this->getone($id); $barr = $this->backarr; if(!$onrs){ $barr = $this->chatcreate($id); return $barr; } $chatid = $onrs['chatid']; $usera = explode('|', $onrs['userlist']); $a = $this->_getchats($id); $adds = $dels = ''; $musn = array(); $op_user= $a['op_user']; foreach($a['urows'] as $k=>$rs){ $user = $rs['user']; $musn[] = $user; if(!in_array($user, $usera)){ $adds.=',"'.$user.'"'; } } foreach($usera as $user){ if(!in_array($user, $musn)){ $dels.=',"'.$user.'"'; } } if(!in_array($op_user, $usera)){ $op_user = $usera[0]; } if($dels!='')$dels = substr($dels, 1); if($adds!='')$adds = substr($adds, 1); $token = $this->getchattoken(); if(isempt($token))return $barr; $url = ''.$this->gettourl('URL_chatupdate').'?access_token='.$token.''; $body = '{"chatid": "'.$chatid.'","op_user": "'.$op_user.'","name": "'.$a['name'].'","owner": "'.$a['owner'].'","add_user_list": ['.$adds.'],"del_user_list": ['.$dels.']}'; $result = c('curl')->postcurl($url, $body); if($result != ''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $narr['name'] = $a['name']; $narr['owner'] = $a['owner']; $narr['userlist'] = $a['users']; $narr['chatid'] = $chatid; $this->update($narr, $id); } } return $barr; } public function upgchatuser($id, $userid, $lx='add') { $onrs = $this->getone($id); $barr = $this->backarr; if(!$onrs)return $barr; $usera = explode('|', $onrs['userlist']); $chatid = $onrs['chatid']; $op_user= $this->rock->adminname; if(!in_array($op_user, $usera)){ $op_user = $usera[0]; } $token = $this->getchattoken(); if(isempt($token))return $barr; $url = ''.$this->gettourl('URL_chatupdate').'?access_token='.$token.''; $body = '{"chatid": "'.$chatid.'","op_user": "'.$op_user.'","'.$lx.'_user_list": ["'.$userid.'"]}'; $result = c('curl')->postcurl($url, $body); if($result != ''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; } return $barr; } public function chatquit($gid, $aid) { $onrs = $this->getone($gid); $barr = $this->backarr; if(!$onrs)return $barr; $op_user= m('admin')->getmou('user', $aid); if(isempt($op_user)){ $barr['msg'] = '人员不存在'; return $barr; } $lista = explode('|', $onrs['userlist']); $lists = ''; foreach($lista as $lis_ta)if($lis_ta!=$op_user)$lists.='|'.$lis_ta.''; if($lists!='')$lists=substr($lists, 1); $gid = $onrs['id']; $chatid = $onrs['chatid']; $token = $this->getchattoken(); if(isempt($token))return $barr; $url = ''.$this->gettourl('URL_chatquit').'?access_token='.$token.''; $body = '{"chatid": "'.$chatid.'","op_user": "'.$op_user.'"}'; $result = c('curl')->postcurl($url, $body); if($result != ''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; } if($lists==''){ $this->delete($gid); }else{ $this->update("`userlist`='$lists'", $gid); } return $barr; } public function chattongbu($id) { $arr = $this->getmessinfor($id, 0); $barr = $this->backarr; if(!$arr){ $barr['msg'] = '消息'.$id.'不存在'; return $barr; } $barr = $this->send($arr['sendid'], $arr['type'], $arr['receid'], $arr['cont'], $arr['msgtype']); $barr['id'] = $id; return $arr; } }