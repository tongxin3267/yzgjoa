<?php
class weixin_userClassModel extends weixinModel { public function initWeixin() { $this->settable('wx_user'); } public function getuserlist() { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userlist').'?access_token='.$token.'&department_id=1&fetch_child=1&status=0'; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $list = $arr->userlist; $idss = "'0'"; foreach($list as $k=>$rs){ $idss .= ",'".$rs->userid."'"; $this->saveuserinfo($rs); } $this->delete("`userid` not in($idss)"); } } return $barr; } private function saveuserinfo($rs) { $userid = $rs->userid; $where = "`userid`='$userid'"; $reos = $this->getone($where,'userid'); if(!$reos)$where=''; $sarr = array( 'userid' => $userid, 'name' => $rs->name, 'department'=> json_encode($rs->department), 'position' => isset($rs->position) ? $rs->position : '', 'mobile' => isset($rs->mobile) ? $rs->mobile : '', 'gender' => $rs->gender, 'email' => isset($rs->email) ? $rs->email : '', 'weixinid' => isset($rs->weixinid) ? $rs->weixinid : '', 'avatar' => isset($rs->avatar) ? $rs->avatar : '', 'status' => $rs->status ); $this->record($sarr, $where); } public function getuserinfo($userid) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userget').'?access_token='.$token.'&userid='.$userid.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->saveuserinfo($arr); } } return $barr; } public function anayface($userid, $hubo=false) { if($hubo){ $barr = $this->getuserinfo($userid); if($barr['errcode'] != 0)return $barr; } $avatar = $this->getmou('avatar', "`userid`='$userid'"); $barr = $this->backarr; if(isempt($avatar)){ $barr['msg'] = '获取失败或可能未关注企业号'; return $barr; } $cont = c('curl')->getcurl($avatar); $farr = c('down')->createimage($cont,'jpg','微信头像'); $barr['face'] = ''; $barr['msg'] = '无法获取,原因很多'; if(isset($farr['id'])){ $dbs = m('admin'); $urs = $dbs->getone("`user`='$userid'",'`id`'); if(!$urs){$barr['msg'] =''.$userid.'不存在';return $barr;} $face = $dbs->changeface($urs['id'], $farr['id']); if($face!=''){ $barr['errcode'] = 0; $barr['face'] = $face; $barr['msg'] = 'ok'; } } return $barr; } public function createuser($userid,$arr=array()) { $str = ''; foreach($arr as $k=>$v){ if($k!='department'){ $str.=',"'.$k.'":"'.$v.'"'; }else{ $str.=',"'.$k.'":'.$v.''; } } $body = '{"userid": "'.$userid.'"'.$str.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_usercreate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arra = json_decode($result); $barr['errcode'] = $arra->errcode; $barr['msg'] = $arra->errmsg; if($arra->errcode==0){ $arr['userid'] = $userid; $this->record($arr); } } return $barr; } public function updateuser($userid,$arr=array()) { $str = ''; foreach($arr as $k=>$v){ if($k!='department'){ $str.=',"'.$k.'":"'.$v.'"'; }else{ $str.=',"'.$k.'":'.$v.''; } } $body = '{"userid": "'.$userid.'"'.$str.'}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userupdate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arra = json_decode($result); $barr['errcode'] = $arra->errcode; $barr['msg'] = $arra->errmsg; if($arra->errcode==0){ $arr['userid'] = $userid; $this->record($arr, "`userid`='$userid'"); } } return $barr; } public function deleteuser($userid) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_userdelete').'?access_token='.$token.'&userid='.$userid.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->delete("`userid`='$userid'"); } } return $barr; } public function deletepluser($arr=array()) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_batchdelete').'?access_token='.$token.''; $barr = $this->backarr; $s1 = ''; foreach($arr as $ss)$s1 .= ',"'.$ss.'"'; if($s1=='')return $barr; $s1 = substr($s1, 1); $body = '{"useridlist":['.$s1.']}'; $result = c('curl')->postcurl($url, $body); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0 || $arr->errcode==60111){ $barr['msg'] = 0; $this->delete('`userid` in('.$s1.')'); } } return $barr; } public function notinadmin($glx=0) { $sql = "select a.`userid` from [Q]wx_user a left join `[Q]admin` b on a.`userid`=b.`user` where b.id is null"; $rows= $this->db->getall($sql); $arr = array(); foreach($rows as $k=>$rs){ $arr[] = $rs['userid']; } return $arr; } public function delusernoinstr() { $arr = $this->notinadmin(); if(!$arr){ $barr = $this->backarr; $barr['msg'] = '没可删除的用户'; return $barr; } return $this->deletepluser($arr); } public function subscribe($user, $zt) { if(isempt($user))return; $where = "`userid`='$user'"; if($this->rows($where)==0)$where=''; $this->record(array( 'userid' => $user, 'status' => $zt, 'optdt' => $this->rock->now ), $where); if($zt == 1){ $urs = m('admin')->getone("`user`='$user'",'`face`,`id`'); if($urs)if(isempt($urs['face']))$this->anayface($user, true); } } private function checkEmail($inAddress) { return filter_var($inAddress, FILTER_VALIDATE_EMAIL); } public function optuserwx($id) { $rs = m('admin')->getone("`id`='$id'",'`name`,`status`,`user`,mobile,email,ranking,weixinid,deptid,sex'); $userid = $rs['user']; $rs1 = $this->getone("`userid`='$userid'"); $arr = array( 'name' => $rs['name'], 'mobile' => $rs['mobile'], 'email' => $rs['email'], 'weixinid' => $rs['weixinid'], 'position' => $rs['ranking'], 'enable' => $rs['status'], 'gender' => ($rs['sex']=='女')?2:1 ); if(!$this->isempt($rs['deptid']))$arr['department']='['.$rs['deptid'].']'; $barr['errcode']=-1; $msg = ''; if(isempt($rs['mobile']) && isempt($rs['email']) && isempt($rs['weixinid'])){ $msg = '手机号,邮箱,微信号不能同时为空'; } if($msg=='' && !$this->isempt($rs['mobile']))if(!is_numeric($rs['mobile']) || strlen($rs['mobile'])!=11){ $msg ='手机号码格式不对'; } if($msg=='' && !$this->isempt($rs['email']))if(!$this->checkEmail($rs['email'])){ $msg ='邮箱格式不对'; } if($msg==''){ if(!$rs1){ $barr = $this->createuser($userid, $arr); }else{ $barr = $this->updateuser($userid, $arr); } }else{ $barr['errcode']=-1; $barr['msg']=$msg; } return $barr; } public function isgeng($urs, $rs) { if(!$urs || !$rs)return 1; $gender = ($rs['sex']=='男') ? '1' : '2'; $isgc = 0; if($urs['position']!=$rs['ranking'] || $urs['name']!=$rs['name'] || $urs['mobile']!=$rs['mobile'] || $urs['department']!='['.$rs['deptid'].']' || $urs['email']!=$rs['email'] || $urs['gender']!=$gender || $urs['enable']!=$rs['status']){ $isgc = 1; } return $isgc; } }