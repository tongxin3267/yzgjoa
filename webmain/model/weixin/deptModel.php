<?php
class weixin_deptClassModel extends weixinModel { public function initWeixin() { $this->settable('wx_dept'); } public function getdeptlist() { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptlist').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errmsg=='ok'){ $list = $arr->department; $idss = '0'; foreach($list as $k=>$rs){ $name = $rs->name; $id = $rs->id; $parentid = $rs->parentid; $order = $rs->order; $idss .= ','.$id.''; $ids = (int)$this->getmou('id', "`id`='$id'"); $where = ''; if($ids>0)$where="`id`=$ids"; $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order ), $where); } $this->delete("id not in($idss)"); } } return $barr; } public function createdept($id, $name, $parentid, $order) { $body = '{"name": "'.$name.'","parentid": "'.$parentid.'","order": "'.$order.'","id": "'.$id.'"}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptcreate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order )); } } return $barr; } public function updatedept($id, $name, $parentid, $order) { $body = '{"name": "'.$name.'","parentid": "'.$parentid.'","order": "'.$order.'","id": "'.$id.'"}'; $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptupdate').'?access_token='.$token.''; $barr = $this->backarr; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->record(array( 'id' => $id, 'name' => $name, 'parentid' => $parentid, 'order' => $order ),"`id`='$id'"); } } return $barr; } public function deletedept($id) { $token = $this->gettoken(); $url = ''.$this->gettourl('URL_deptdelete').'?access_token='.$token.'&id='.$id.''; $barr = $this->backarr; $result = c('curl')->getcurl($url); if(!$this->isempt($result)){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; if($arr->errcode==0){ $this->delete($id); } } return $barr; } }