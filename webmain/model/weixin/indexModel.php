<?php
class weixin_indexClassModel extends weixinModel { public function setlogin($rand, $uid) { if($rand=='')$rand=$this->db->ranknum('[Q]wx_login','loginkey'); $where = "`loginkey`='$rand'"; $arr['uid'] = $uid; $arr['loginkey'] = $rand; $arr['lastdt'] = $this->rock->now(); $dbs = m('wx_login'); $to = $dbs->rows($where); if($to==0){ $where = ''; $arr['adddt'] = $arr['lastdt']; } $dbs->record($arr, $where); return $rand; } public function getagentid($name) { $agesta = explode(',', $name); $name = $agesta[0]; $sid = -1; $where = "`name`='$name'"; if(is_numeric($name))$where='`agentid`='.$name.''; $nsrs = $this->db->getone('[Q]wx_agent', $where, 'agentid'); if($nsrs){ $sid = (int)$nsrs['agentid']; } if($sid==-1 && count($agesta)>1)$sid = $this->getagentid($agesta[1]); return $sid; } private function sendmsg($touid, $agentname, $body) { $agentid= $this->getagentid($agentname); $msg = ''; $barr = array('errcode' => -1,'msg' => 'sorry!error'); if($agentid==-1){ $msg= 'not found agent['.$agentname.']'; $barr['msg'] = $msg; return $barr; } $touser = ''; if($touid=='all'){ $touser = '@all'; }else{ $uarrs = $this->db->getall("select a.`user` from `[Q]admin` a left join `[Q]wx_user` b on a.`user`=b.`userid` where a.`status`=1 and b.`status`=1 and a.`id` in($touid)"); foreach($uarrs as $k=>$rs){ $touser.='|'.$rs['user'].''; } if($touser!='')$touser = substr($touser, 1); } if($touser==''){ $msg= 'not found touser'; $barr['msg'] = $msg; return $barr; } $body = str_replace(array('{touser}', '{agentid}'), array($touser, $agentid), $body); if(getconfig('asynsend')){ m('reim')->asynurl('asynrun','wxsendmsg', array( 'body' => $this->rock->jm->base64encode($body) )); $barr['errcode'] = 0; $barr['msg'] = '异步发送'; return $barr; } $barr = $this->sendbody($body); return $barr; } public function sendbody($body) { $barr = array('errcode' => -1,'msg' => 'sorry!error'); $token = $this->gettoken(); $url = ''.$this->gettourl('URL_messagesend').'?access_token='.$token.''; $result = c('curl')->postcurl($url, $body); if($result!=''){ $arr = json_decode($result); $barr['errcode'] = $arr->errcode; $barr['msg'] = $arr->errmsg; } return $barr; } public function sendtext($touid, $agentname, $cont) { $body = '{"touser": "{touser}","msgtype": "text","agentid":{agentid},"text": {"content": "'.$cont.'"}, "safe":"0"}'; return $this->sendmsg($touid, $agentname, $body); } public function sendnews($touid, $agentname, $cont0=array(), $cont1=false, $cont2=false) { $s1 = ''; foreach($cont0 as $k=>$v)$s1.=',"'.$k.'":"'.$v.'"'; if($s1!='')$s1 = substr($s1,1); $articles = '[{'.$s1.'}]'; $body = '{"touser": "{touser}","msgtype": "news","agentid":{agentid},"news":{"articles": '.$articles.'}}'; $barr = $this->sendmsg($touid, $agentname, $body); return $barr; } }