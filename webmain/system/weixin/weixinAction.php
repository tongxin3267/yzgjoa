<?php
class weixinClassAction extends Action { public function setsaveAjax() { $this->option->setval('weixin_corpid', $this->post('corpid')); $this->option->setval('weixin_secret', $this->post('secret')); $this->option->setval('weixin_chatsecret', $this->post('chatsecret')); $this->option->setval('weixin_kefusecret', $this->post('kefusecret')); $this->option->setval('weixin_huitoken', $this->post('huitoken')); $this->option->setval('weixin_aeskey', $this->post('aeskey')); $this->option->setval('weixin_chattb', $this->post('chattb')); m('weixin:index')->clearalltoken(); $this->backmsg(); } public function getsetAjax() { $arr= array(); $arr['corpid'] = $this->option->getval('weixin_corpid'); $arr['secret'] = $this->option->getval('weixin_secret'); $arr['chatsecret'] = $this->option->getval('weixin_chatsecret'); $arr['kefusecret'] = $this->option->getval('weixin_kefusecret'); $arr['huitoken'] = $this->option->getval('weixin_huitoken'); $arr['aeskey'] = $this->option->getval('weixin_aeskey'); $arr['chattb'] = $this->option->getval('weixin_chattb'); $arr['chaturl'] = ''.URL.'api.php?m=chatwx'; echo json_encode($arr); } public function testsendAjax() { $lx = (int)$this->get('lx'); if($lx==0){ $val = m('weixin:weixin')->getticket(); }else{ $val = 'ok'; $suser= m('wx_user')->getmou('userid', "`name`<>'$this->adminname'"); $sendi= (int)m('admin')->getmou('id',"`user`='$suser'"); if($lx==2){ $barr = m('weixin:kefu')->send($sendi, $this->adminid,"这是一个企业客服消息测试，不要紧张\n".$this->now.""); }else{ $barr = m('weixin:chat')->send($sendi, 'user', $this->adminid,"这是一个企业会话IM发送测试，不要紧张\n".$this->now.""); } if($barr['errcode']!=0){ showreturn('', $barr['msg']); } } if($val==''){ showreturn('','测试失败'); }else{ showreturn('','测试成功'); } } public function updatedeptAjax() { $arr = m('weixin:dept')->getdeptlist(); $this->returnjson($arr); } public function optdeptAjax() { $ids = $this->get('ids'); $db = m('weixin:dept'); $oi = $db->rows($ids); $rs = $this->db->getone('[Q]dept','id='.$ids.''); if($oi==0){ $barr = $db->createdept($rs['id'], $rs['name'], $rs['pid'], $rs['sort']); }else{ $barr = $db->updatedept($rs['id'], $rs['name'], $rs['pid'], $rs['sort']); } $this->returnjson($barr); } public function deletedeptAjax() { $ids = $this->get('ids'); $arr = m('weixin:dept')->deletedept($ids); $this->returnjson($arr); } public function deptwxdataAjax() { $this->rows = array(); $this->getdeptwx(0, 1); $this->returnjson(array( 'totalCount'=> 0, 'rows' => $this->rows )); } private function getdeptwx($pid, $oi) { $db = m('wx_dept'); $menu = $db->getall("`parentid`='$pid' order by `order`",'*'); foreach($menu as $k=>$rs){ $sid = $rs['id']; $rs['level'] = $oi; $rs['stotal'] = $db->rows("`parentid`='$sid'"); $zt = $this->db->rows('[Q]dept', $sid); $rs['zt'] = $zt; $this->rows[] = $rs; $this->getdeptwx($sid, $oi+1); } } public function deptdataAjax() { $this->rows = array(); $this->getdept(0, 1); $this->returnjson(array( 'totalCount'=> 0, 'rows' => $this->rows )); } private function getdept($pid, $oi) { $db = m('dept'); $menu = $db->getall("`pid`='$pid' order by `sort`",'*'); foreach($menu as $k=>$rs){ $sid = $rs['id']; $rs['level'] = $oi; $rs['stotal'] = $db->rows("`pid`='$sid'"); $zt = $this->db->rows('[Q]wx_dept', $sid); $rs['zt'] = $zt; $this->rows[] = $rs; $this->getdept($sid, $oi+1); } } public function sendkefuAjax() { $cont = $this->post('cont'); $receid = $this->post('receid'); $arr = m('weixin:kefu')->send($this->adminid, $receid, $cont); $this->returnjson($arr); } public function beforeusershow($table) { $fields = 'id,name,`user`,deptname,status,tel,ranking,deptid,superman,loginci,sex,mobile,email,weixinid,sort,face'; $s = ''; $key = $this->post('key'); if($key!=''){ $s = " and (`name` like '%$key%' or `user` like '%$key%' or `ranking` like '%$key%' or `deptname` like '%$key%') "; } return array( 'fields'=> $fields, 'where' => $s ); } public function afterusershow($table, $rows) { $db = m('weixin:user'); foreach($rows as $k=>$rs){ $iscj = 0; $wxstatus = 0; $wxweixinid = ''; $urs = $db->getone("`userid`='".$rs['user']."'"); if($urs){ $iscj = 1; $wxstatus = $urs['status']; $wxweixinid = $urs['weixinid']; } $rows[$k]['iscj'] = $iscj; $rows[$k]['wxstatus'] = $wxstatus; $rows[$k]['wxweixinid'] = $wxweixinid; $rows[$k]['isgc'] = $db->isgeng($urs, $rs); } $noarr = $db->notinadmin(); return array('rows'=>$rows,'notstr'=>join(',', $noarr)); } public function reloaduserAjax() { $arr = m('weixin:user')->getuserlist(); $this->returnjson($arr); } public function optuserAjax() { $id = (int)$this->post('id'); $barr = m('weixin:user')->optuserwx($id); $this->returnjson($barr); } public function delalluserAjax() { $arr = m('weixin:user')->delusernoinstr(); $this->returnjson($arr); } public function updateagentAjax() { $barr = m('weixin:agent')->getagentlist(); $this->returnjson($barr); } public function getagentAjax() { $agentid = (int)$this->request('agentid'); $barr = m('weixin:agent')->getagent($agentid); $this->returnjson($barr); } public function setagentAjax() { $agentid = (int)$this->request('agentid'); $barr = m('weixin:agent')->setagent($agentid); $this->returnjson($barr); } public function sendagentAjax() { $name = $this->post('name'); $msg = $this->post('msg'); $barr = m('weixin:index')->sendtext('all', $name, $msg); $this->returnjson($barr); } public function getchatlistAjax() { $barr = m('weixin:chat')->getchatlist(); $this->returnjson($barr); } public function getchatinfoAjax() { $barr = m('weixin:chat')->getchatinfo($this->get('chatid')); $this->returnjson($barr); } public function aftechatshow($table, $rows) { $db = m('weixin:chat'); foreach($rows as $k=>$rs){ $zt = $db->rows($rs['id']); $rows[$k]['zt'] = $zt; $rows[$k]['sontts'] = m('im_groupuser')->rows("gid='".$rs['id']."'"); } return array('rows'=>$rows); } public function createchatAjax() { $id = (int)$this->get('id'); $zt = m('wx_chat')->rows($id); if($zt==0){ $barr = m('weixin:chat')->chatcreate($id); }else{ $barr = m('weixin:chat')->chatupdate($id); } $this->returnjson($barr); } public function sendchatAjax() { $gid = (int)$this->post('gid'); $cont = $this->post('msg'); $barr = m('weixin:chat')->send($this->adminid, 'group', $gid, $cont); $this->returnjson($barr); } }